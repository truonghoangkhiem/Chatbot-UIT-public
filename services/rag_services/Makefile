# Vietnamese Hybrid RAG System with Ports & Adapters Architecture
# Commands for managing the Clean Architecture implementation

.PHONY: help install start stop restart status clean test demo sample-data architecture \
        demo-clean test-arch migrate-check arch-info clean-arch start-legacy start-clean \
        validate cleanup-project info docs opensearch-create opensearch-delete opensearch-reset \
        opensearch-stats opensearch-health index-sample index-clear search-test perf-test \
        clean-cache logs logs-opensearch dev-run dev-shell test-vietnamese test-components test-full

# Default target
help:
	@echo "ğŸš€ Vietnamese Hybrid RAG System - Ports & Adapters Architecture"
	@echo "================================================================"
	@echo ""
	@echo "ğŸ—ï¸  Architecture Commands:"
	@echo "  ğŸ¯ demo           - Demo Ports & Adapters architecture"
	@echo "  ğŸ§ª test-arch      - Test architecture components"
	@echo "  ï¿½ arch-info      - Show architecture information"
	@echo "  ï¿½ test-migration - Run comprehensive migration tests"
	@echo ""
	@echo "ğŸ“¦ Service Management:"
	@echo "  ğŸ“¦ install        - Install Python dependencies"
	@echo "  ğŸš€ start          - Start all services (OpenSearch + RAG)"
	@echo "  â¹ï¸  stop           - Stop all services"
	@echo "  ğŸ”„ restart        - Restart all services"
	@echo "  ğŸ“Š status         - Check service status"
	@echo "  ğŸ§¹ clean          - Clean up containers and volumes"
	@echo ""
	@echo "ğŸ§ª Testing & Demo:"
	@echo "  ğŸ“š sample-data    - Create sample Vietnamese documents"
	@echo "  ğŸ§ª test-vietnamese - Test Vietnamese search capabilities"
	@echo "  ğŸ”¬ test-full      - Run complete test pipeline"
	@echo ""
	@echo "ğŸ“‚ Index Management:"
	@echo "  ğŸ“‚ opensearch-*   - OpenSearch index management"
	@echo "  â“ help           - Show this help message"

# Installation
install:
	@echo "ğŸ“¦ Installing Python dependencies..."
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed!"

# Service management
start:
	@echo "ğŸš€ Starting Vietnamese Hybrid RAG services..."
	@echo "ğŸ—ï¸  Architecture: Ports & Adapters (Clean Architecture)"
	@echo "ğŸ“‚ Checking OpenSearch..."
	@if curl -s http://localhost:9200/_cluster/health > /dev/null 2>&1; then \
		echo "âœ… OpenSearch already running"; \
	else \
		echo "ğŸ“‚ Starting OpenSearch..."; \
		cd docker && docker-compose up -d opensearch || (echo "âš ï¸  Cleaning existing container..." && docker rm -f vietnamese-rag-opensearch 2>/dev/null && docker-compose up -d opensearch); \
		echo "â³ Waiting for OpenSearch to be ready..."; \
		sleep 15; \
	fi
	@echo "ğŸ¤– Starting RAG service..."
	@if pgrep -f "uvicorn app.main:app" > /dev/null; then \
		echo "âœ… RAG service already running"; \
	else \
		PYTHONPATH=. python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload & \
		echo "â³ Waiting for RAG service to start..."; \
		sleep 5; \
	fi
	@echo "âœ… All services started!"
	@echo "ğŸŒ RAG API: http://localhost:8000"
	@echo "ğŸ” OpenSearch: http://localhost:9200"
	@echo "ğŸ›ï¸  Architecture docs: http://localhost:8000/docs"

start-dev:
	@echo "ğŸš€ Starting development environment..."
	cd docker && docker-compose up -d
	@echo "â³ Waiting for services to be ready..."
	@sleep 15
	@echo "âœ… Development environment ready!"

stop:
	@echo "â¹ï¸  Stopping services..."
	pkill -f "uvicorn app.main:app" || true
	cd docker && docker-compose down
	@echo "âœ… All services stopped!"

restart: stop start
	@echo "ğŸ”„ Services restarted!"

status:
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	@echo -n "ğŸ¤– RAG Service: "
	@curl -s http://localhost:8000/v1/health > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Down"
	@echo -n "ğŸ” OpenSearch: "
	@curl -s http://localhost:9200 > /dev/null 2>&1 && echo "âœ… Running" || echo "âŒ Down"
	@echo -n "ğŸ“¦ Docker Services: "
	@cd docker && docker-compose ps --services --filter status=running | wc -l | xargs -I {} echo "{} running"

# Development commands
dev-run:
	@echo "ğŸ› ï¸  Running in development mode..."
	PYTHONPATH=. python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

dev-shell:
	@echo "ğŸš Opening development shell..."
	cd docker && docker-compose exec opensearch bash

# Sample data management
sample-data:
	@echo "ğŸ“š Creating sample Vietnamese data..."
	python scripts/create_sample_data.py

# Testing commands
test-vietnamese:
	@echo "ğŸ‡»ğŸ‡³ Testing Vietnamese search capabilities..."
	python scripts/test_vietnamese_search.py

test-components:
	@echo "ğŸ§ª Testing system components without Docker..."
	python scripts/test_without_docker.py

# Architecture demo
demo:
	@echo "ğŸ—ï¸  Running Ports & Adapters architecture demo..."
	python scripts/demo_clean_architecture.py

test-arch:
	@echo "ğŸ§ª Testing architecture components..."
	@echo "ğŸ“¦ Testing DI Container..."
	python -c "from core.container import get_container; c = get_container(); print('âœ… Container OK')"
	@echo "ğŸ” Testing Core Domain..."
	python -c "from core.domain.search_service import SearchService; print('âœ… Domain Service OK')"
	@echo "ğŸ”Œ Testing Adapters..."
	python -c "from adapters.api_facade import get_search_facade; print('âœ… API Facade OK')"
	@echo "âœ… All architecture components working!"

test-migration:
	@echo "ğŸ§ª Running comprehensive migration tests..."
	python scripts/validate_migration_readiness.py

arch-info:
	@echo "ğŸ—ï¸  Architecture Information"
	@echo "============================="
	@echo "ğŸ“š Documentation:"
	@echo "   ğŸ“– Architecture Guide: PORTS_AND_ADAPTERS.md"
	@echo "   ğŸ“‹ Refactoring Summary: REFACTORING_SUMMARY.md"
	@echo ""
	@echo "ğŸ›ï¸  Architecture Layers:"
	@echo "   ğŸ¯ Core Domain: core/domain/"
	@echo "   ğŸ”Œ Ports: core/ports/"
	@echo "   ğŸ—ï¸  Adapters: adapters/"
	@echo "   ğŸŒ API Layer: app/api/"
	@echo ""
	@echo "ğŸ”§ Configuration:"
	@echo "   VECTOR_BACKEND=${VECTOR_BACKEND:-faiss}"
	@echo "   USE_HYBRID_SEARCH=${USE_HYBRID_SEARCH:-true}"
	@echo "   Architecture: Ports & Adapters (Clean Architecture)"

# Full test pipeline
test-full: sample-data test-vietnamese demo test-migration
	@echo "âœ… Complete testing pipeline finished!"

# OpenSearch management
opensearch-create:
	@echo "ğŸ“‚ Creating OpenSearch index with Vietnamese analyzer..."
	python -c "import requests; r=requests.post('http://localhost:8000/v1/opensearch/create-index'); print(f'Status: {r.status_code}')"

opensearch-delete:
	@echo "ğŸ—‘ï¸  Deleting OpenSearch index..."
	python -c "import requests; r=requests.delete('http://localhost:8000/v1/opensearch/delete-index'); print(f'Status: {r.status_code}')"

opensearch-reset: opensearch-delete opensearch-create
	@echo "ğŸ”„ OpenSearch index reset complete!"

opensearch-stats:
	@echo "ğŸ“Š Getting OpenSearch index statistics..."
	python -c "import requests; r=requests.get('http://localhost:8000/v1/opensearch/stats'); print(r.json() if r.status_code == 200 else f'Error: {r.status_code}')"

opensearch-health:
	@echo "ğŸ¥ Checking OpenSearch health..."
	python -c "import requests; r=requests.get('http://localhost:8000/v1/opensearch/health'); print(r.json() if r.status_code == 200 else f'Error: {r.status_code}')"

# Index management
index-sample:
	@echo "ğŸ“ Indexing sample documents..."
	python -c "from scripts.create_sample_data import index_sample_data; index_sample_data()"

index-clear:
	@echo "ğŸ§¹ Clearing all indexed documents..."
	python -c "import requests; r=requests.delete('http://localhost:8000/v1/opensearch/clear'); print(f'Status: {r.status_code}')"

# Search testing
search-test:
	@echo "ğŸ” Running search tests..."
	python -c "import requests; r=requests.post('http://localhost:8000/v1/search', json={'query': 'tuyá»ƒn sinh', 'search_mode': 'hybrid'}); print(f'Found: {len(r.json().get(\"hits\", []))} results')"

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning up..."
	cd docker && docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup complete!"

clean-cache:
	@echo "ğŸ§¹ Cleaning Python cache..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	@echo "âœ… Cache cleaned!"

clean-arch:
	@echo "ğŸ§¹ Cleaning architecture artifacts..."
	@echo "ğŸ—‘ï¸  Removing Python cache..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	@echo "ğŸ—‘ï¸  Resetting DI container..."
	python -c "from core.container import reset_container; reset_container(); print('âœ… Container reset')" 2>/dev/null || echo "â„¹ï¸  Container not initialized"
	@echo "âœ… Architecture cleanup complete!"

# Logs
logs:
	@echo "ğŸ“‹ Showing service logs..."
	cd docker && docker-compose logs -f

logs-opensearch:
	@echo "ğŸ“‹ Showing OpenSearch logs..."
	cd docker && docker-compose logs -f opensearch

# Performance testing
perf-test:
	@echo "âš¡ Running performance tests..."
	python scripts/performance_test.py

# System info
info:
	@echo "â„¹ï¸  System Information"
	@echo "====================="
	@echo "ğŸ Python: $(shell python --version)"
	@echo "ğŸ³ Docker: $(shell docker --version 2>/dev/null || echo 'Not installed')"
	@echo "ğŸ“ Project: $(shell pwd)"
	@echo "ğŸ—ï¸  Architecture: Ports & Adapters (Clean Architecture)"
	@echo "ğŸ“¦ Key Dependencies:"
	@pip list | grep -E "(opensearch|faiss|sentence|transformers|llama-index)" || echo "   No key dependencies found"
	@echo ""
	@echo "ğŸ“‚ Project Structure:"
	@echo "   ğŸ¯ Core: $(shell find core -name "*.py" 2>/dev/null | wc -l) files"
	@echo "   ğŸ”Œ Adapters: $(shell find adapters -name "*.py" 2>/dev/null | wc -l) files"
	@echo "   ğŸŒ API: $(shell find app -name "*.py" 2>/dev/null | wc -l) files"
	@echo "   ğŸ“ Scripts: $(shell find scripts -name "*.py" 2>/dev/null | wc -l) files"

# Validation and cleanup
validate:
	@echo "âœ… Validating project structure..."
	@echo "ğŸ“‚ Checking core architecture files..."
	@test -f core/container.py && echo "   âœ… DI Container: OK" || echo "   âŒ DI Container: Missing"
	@test -f core/domain/search_service.py && echo "   âœ… Domain Service: OK" || echo "   âŒ Domain Service: Missing"
	@test -f core/ports/repositories.py && echo "   âœ… Repository Ports: OK" || echo "   âŒ Repository Ports: Missing"
	@echo "ğŸ”Œ Checking adapter implementations..."
	@test -f adapters/api_facade.py && echo "   âœ… API Facade: OK" || echo "   âŒ API Facade: Missing"
	@test -f adapters/llamaindex_vector_adapter.py && echo "   âœ… Vector Adapter: OK" || echo "   âŒ Vector Adapter: Missing"
	@echo "ğŸ“š Checking documentation..."
	@test -f PORTS_AND_ADAPTERS.md && echo "   âœ… Architecture Docs: OK" || echo "   âŒ Architecture Docs: Missing"
	@test -f REFACTORING_SUMMARY.md && echo "   âœ… Summary Docs: OK" || echo "   âŒ Summary Docs: Missing"
	@echo "âœ… Validation complete!"

cleanup-project:
	@echo "ğŸ§¹ Cleaning up project files..."
	@echo "ğŸ—‘ï¸  Removing Python cache..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	@echo "ğŸ—‘ï¸  Removing temporary files..."
	find . -name "*.tmp" -delete 2>/dev/null || true
	find . -name "*.log" -delete 2>/dev/null || true
	find . -name "*~" -delete 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Removing OS specific files..."
	find . -name ".DS_Store" -delete 2>/dev/null || true
	find . -name "Thumbs.db" -delete 2>/dev/null || true
	@echo "âœ… Project cleanup complete!"

# Documentation
docs:
	@echo "ğŸ“š Documentation Links"
	@echo "====================="
	@echo "ğŸŒ API Docs: http://localhost:8000/docs"
	@echo "ğŸ” OpenSearch: http://localhost:9200"
	@echo "ğŸ“Š Health Check: http://localhost:8000/v1/health"
	@echo "ğŸ§ª Test endpoint: make search-test"
	@echo ""
	@echo "ğŸ—ï¸  Architecture Documentation:"
	@echo "  ğŸ“– Ports & Adapters Guide: PORTS_AND_ADAPTERS.md"
	@echo "  ğŸ“‹ Refactoring Summary: REFACTORING_SUMMARY.md"
	@echo "  ğŸ¯ Demo Script: scripts/demo_clean_architecture.py"
	@echo ""
	@echo "ğŸš€ Quick Start (Clean Architecture):"
	@echo "  1. make install"
	@echo "  2. make start-clean"
	@echo "  3. make sample-data"
	@echo "  4. make demo-clean"
	@echo ""
	@echo "ğŸ”§ Environment Variables:"
	@echo "  USE_CLEAN_ARCHITECTURE=true|false (default: true)"
	@echo "  VECTOR_BACKEND=faiss|chroma (default: faiss)"
	@echo "  USE_HYBRID_SEARCH=true|false (default: true)"
